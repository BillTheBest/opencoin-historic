Messages between any two parties of the network


Wallet & Wallet         Wallet & IS                     Wallet & DSDB

=============           =====================           =================
= BLANK     =           = MINTING_KEY       =           = LOCK_COIN     =
= COIN      =           = TRANSFER_TOKEN    =           = UNLOCK_COIN  =
=============           = DSDB_KEY          =           =================
                        =====================
                        
    Prior: All messages between two entities that can occur directly before this one
    Follow: All messages between two entities that can occur directly after this one
    
    Hello is the initial handshake between two entities or the state after a Goodbye
    Goodbye is the end of a transaction, although also a Hello for a new transaction

============================================================================


********************
* Wallet to Wallet *
********************

=============
= BLANK     =
= COIN      =
=============

BLANK
-----

A:
  BLANK_PRESENT dsdb_keycertificate #hex_string(number_of_blanks)
                blank1
                blank2
        Prior:  Hello
        Follow: BLANK_FAILURE
                BLANK_REJECT
                BLANK_ACCEPT

B:
  BLANK_REJECT  #hex_string(number_of_failures)
                #base64(encrypted serial of blank1) "Reason1"
                #base64(encrypted serial of blank2) "Reason2"
                    Reasons:
                        Malformed blank
                        Unknown issuer
                            Note: Also used for an untrusted issuer
        Prior:  BLANK_PRESENT
        Follow: Goodbye
                        
  BLANK_REJECT  #hex_string(0) "reason"
                    Reason:
                        Cancelled
                        Insufficient currency
        Prior:  BLANK_PRESENT
        Follow: Goodbye
                        

  BLANK_FAILURE #hex_string(number_of_failures)
                #base64(encrypted serial of blank1) "Reason1"
                #base64(encrypted serial of blank2) "Reason2"
                    Reasons:
                        DSDB: Key ID of DSDB is unknown or expired      Permanant
                        DSDB: Key ID of blank is unknown or expired     Permanant
                        DSDB: Decryption of serial failed               Permanant
                        DSDB: Serial already redeemed                   Permanant
                        DSDB: Serial locked (not spent)                 Temporary
        Prior:  BLANK_PRESENT
        Follow: Goodbye

  BLANK_FAILURE #hex_string(0) "reason"
                    Reasons:
                        Cancelled
        Prior:  BLANK_PRESENT
                BLANK_ACCEPT (Message from self)
        Follow: Goodbye

  BLANK_ACCEPT
        Note:   After ACCEPT, a REJECT #hex_string(0) can be given to abort the transaction
        Prior:  BLANK_PRESENT
        Follow: COIN_REDEEM
                BLANK_REJECT (Message from self)



COINS
-----

A:
  COIN_REDEEM   #hex_string(number_of)
                #base64(coin1)
                #base64(coin2)
        Prior:  BLANK_ACCEPT
        Follow: COIN_REJECT
                COIN_ACCEPT

B:
  COIN_REJECT   #hex_string(number_of)
                #base64(coin1) "Reason1"
                #base64(coin2) "Reason2"
                    Reasons:
                        Invalid coin
                        Unknown coin
                            Note: Used when the coin we are given is different than the blank
        Prior:  COIN_REDEEM
        Follow: COIN_REDEEM
                Goodbye

  COIN_REJECT   #hex_string(0) "Reason"
                    Reasons:
                        *I can't think of anything valid*
        Prior:  COIN_REDEEM
        Follow: COIN_REDEEM
                Goodbye

  COIN_ACCEPT
        Prior:  COIN_REDEEM
        Follow: Goodbye




============================================================================


****************
* Wallet to IS *
****************

=====================
= MINTING_KEY       =
= TRANSFER_TOKEN    =
= DSDB_KEY          =
=====================

MINTING_KEY
-----------

Wallet:
  MINTING_KEY_FETCH_DENOMINATION    #string(denomination)
    Prior:  Hello
    Follow: MINTING_KEY_PASS
            MINTING_KEY_FAILURE
            
  MINTING_KEY_FETCH_KEYID   #hexstring(key_id)
    Prior:  Hello
    Follow: MINTING_KEY_PASS
            MINTING_KEY_FAILURE

IS:
  MINTING_KEY_PASS  keycertificate
    Prior:  MINTING_KEY_FETCH_DENOMINATION
            MINTING_KEY_FETCH_KEYID
    Follow: Goodbye
            
  MINTING_KEY_FAILURE   "Reason"
                        Reasons:
                            Unknown denomination
                            Unknown key_id
    Prior:  MINTING_KEY_FETCH_DENOMINATION
            MINTING_KEY_FETCH_KEYID
    Follow: Goodbye
  


TRANSFER_TOKEN
--------------

Wallet:
  TRANSFER_TOKEN_REQUEST    #base64(transaction_id)
                            list(option1,...)
                            target
                            list(blind1,...)
                            list(coin1,...)
    Prior:  Hello
    Follow: TRANSFER_TOKEN_REJECT
            TRANSFER_TOKEN_ACCEPT
            TRANSFER_TOKEN_DELAY
            
  TRANSFER_TOKEN_RESUME #base64(transaction_id)
    Prior:  Hello
    Follow: TRANSFER_TOKEN_REJECT
            TRANSFER_TOKEN_ACCEPT
            TRANSFER_TOKEN_DELAY
                
IS:
  TRANSFER_TOKEN_REJECT #base64(transaction_id) "Reason"
                        list( (#key_id(blind1), "Reason1"), ...)
                        list( (#key_id(coin1), "Reason1"), ...)
                        Reasons:
                            **Haven't done this yet**
    Prior:  TRANSFER_TOKEN_REQUEST
            TRANSFER_TOKEN_RESUME
    Follow: Goodbye
    
  TRANSFER_TOKEN_ACCEPT #base64(transaction_id) "Message"
                        list(signed_blind1,...)
                        Messages:
                            **Haven't done this yet**
    Prior:  TRANSFER_TOKEN_REQUEST
            TRANSFER_TOKEN_RESUME
    Follow: Goodbye
    
  TRANSFER_TOKEN_DELAY  #base64(transaction_id) "Message"
                        Messages:
                            **Haven't done this yet**
    Prior:  TRANSFER_TOKEN_REQUEST
            TRANSFER_TOKEN_RESUME
    Follow: Goodbye



DSDB_KEY
--------------

Wallet:
  DSDB_KEY_REQUEST
    Prior:  Hello
    Follow: DSDB_KEY_PASS

IS:
  DSDB_KEY_PASS keycertificate
    Prior:  DSDB_KEY_REQUEST
    Follow: Goodbye


============================================================================


******************
* Wallet to DSDB *
******************

=================
= LOCK_COIN     =
= UNLOCK_COIN   =
=================

LOCK_COIN
----------

Wallet:
  LOCK_COIN_REQUEST #key_id_of_DSDB #hex_string(transaction_id) #hex_string(#number_of_obfuscated_blanks)
                    #key_identifier1 #encrypted_serial1
                    #key_identifier2 #encrypted_serial2
    Prior:  Hello
    Follow: LOCK_COIN_ACCEPT
            LOCK_COIN_FAILURE

DSDB:
  LOCK_COIN_ACCEPT      #hex_string(transaction_id) TIME(lock_expires)
    Prior:  LOCK_COIN_REQUEST
    Follow: Goodbye

  LOCK_COIN_FAILURE #hex_string(transaction_id) #hex_string(number_of_failures)
                    #key_identifier1 #encrypted_serial1 "Reason 1"
                    #key_identifier2 #encrypted_serial2 "Reason 2"
                        Reasons:
                            Key ID of DSDB is unknown or expired        Permanant
                            Key ID of blank is unknown or expired       Permanant
                            Decryption of serial failed                 Permanant
                            Serial already redeemed                     Permanant
                            Serial locked (not spent)                   Temporary
    Prior:  LOCK_COIN_REQUEST
    Follow: Goodbye



UNLOCK_COIN
-----------

Wallet:
  UNLOCK_COIN_REQUEST   #hex_string(transaction_id)
    Prior:  Hello
    Follow: UNLOCK_COIN_PASS
            UNLOCK_COIN_FAILURE

DSDB:
  UNLOCK_COIN_PASS
    Prior:  UNLOCK_COIN_REQUEST
    Follow: Goodbye
    
  UNLOCK_COIN_FAILURE   #hex_string(transaction_id) "Reason"
                            Reasons:
                                Unknown transaction_id
                                Transaction already completed
                                Lock expired *Not really a failure...*
    Prior:  UNLOCK_COIN_REQUEST
    Follow: Goodbye




